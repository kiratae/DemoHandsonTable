/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/hyperformula@0.1.3/es/parser/ParserWithCaching.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import"core-js/modules/es.symbol";import"core-js/modules/es.symbol.description";import"core-js/modules/es.symbol.iterator";import"core-js/modules/es.array.concat";import"core-js/modules/es.array.from";import"core-js/modules/es.array.iterator";import"core-js/modules/es.array.join";import"core-js/modules/es.array.map";import"core-js/modules/es.array.slice";import"core-js/modules/es.function.name";import"core-js/modules/es.object.assign";import"core-js/modules/es.object.to-string";import"core-js/modules/es.regexp.exec";import"core-js/modules/es.regexp.to-string";import"core-js/modules/es.string.iterator";import"core-js/modules/es.string.split";import"core-js/modules/web.dom-collections.iterator";function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_unsupportedIterableToArray(e,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,r):void 0}}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,a=new Array(r);t<r;t++)a[t]=e[t];return a}function _iterableToArrayLimit(e,r){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var t=[],a=!0,s=!1,i=void 0;try{for(var o,n=e[Symbol.iterator]();!(a=(o=n.next()).done)&&(t.push(o.value),!r||t.length!==r);a=!0);}catch(e){s=!0,i=e}finally{try{a||null==n.return||n.return()}finally{if(s)throw i}}return t}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var a=r[t];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),e}import{tokenMatcher}from"chevrotain";import{ErrorType}from"../Cell";import{AstNodeType,buildParsingErrorAst}from"./";import{cellAddressFromString,columnAddressFromString,rowAddressFromString}from"./addressRepresentationConverters";import{imageWithWhitespace,ParsingErrorType,RangeSheetReferenceType}from"./Ast";import{binaryOpTokenMap}from"./binaryOpTokenMap";import{Cache}from"./Cache";import{FormulaLexer,FormulaParser}from"./FormulaParser";import{buildLexerConfig,CellReference,ColumnRange,ProcedureName,RowRange,WhiteSpace}from"./LexerConfig";import{formatNumber}from"./Unparser";export var ParserWithCaching=function(){function e(r,t,a){_classCallCheck(this,e),this.config=r,this.functionRegistry=t,this.sheetMapping=a,this.statsCacheUsed=0,this.lexerConfig=buildLexerConfig(r),this.lexer=new FormulaLexer(this.lexerConfig),this.formulaParser=new FormulaParser(this.lexerConfig,this.sheetMapping),this.cache=new Cache(this.functionRegistry)}return _createClass(e,[{key:"parse",value:function(e,r){var t=this.lexer.tokenizeFormula(e);if(t.errors.length>0){var a=t.errors.map(function(e){return{type:ParsingErrorType.LexingError,message:e.message}});return{ast:buildParsingErrorAst(),errors:a,hasVolatileFunction:!1,hasStructuralChangeFunction:!1,dependencies:[]}}var s=this.computeHashFromTokens(t.tokens,r),i=this.cache.get(s);if(i)++this.statsCacheUsed;else{var o=bindWhitespacesToTokens(t.tokens),n=this.formulaParser.parseFromTokens(o,r);if(n.errors.length>0)return Object.assign(Object.assign({},n),{hasVolatileFunction:!1,hasStructuralChangeFunction:!1,dependencies:[]});i=this.cache.set(s,n.ast)}var c=i;return{ast:c.ast,errors:[],hasVolatileFunction:c.hasVolatileFunction,hasStructuralChangeFunction:c.hasStructuralChangeFunction,dependencies:c.relativeDependencies}}},{key:"fetchCachedResultForAst",value:function(e){var r=this.computeHashFromAst(e);return this.fetchCachedResult(r)}},{key:"fetchCachedResult",value:function(e){var r=this.cache.get(e);if(null===r)throw new Error("There is no AST with such key in the cache");return{ast:r.ast,errors:[],hasVolatileFunction:r.hasVolatileFunction,hasStructuralChangeFunction:r.hasStructuralChangeFunction,dependencies:r.relativeDependencies}}},{key:"computeHashFromTokens",value:function(e,r){for(var t,a="",s=0;s<e.length;){var i=e[s];if(tokenMatcher(i,CellReference)){var o=cellAddressFromString(this.sheetMapping,i.image,r);a=void 0===o?a.concat(i.image):a.concat(o.hash(!0))}else if(tokenMatcher(i,ProcedureName)){var n=i.image.toUpperCase().slice(0,-1),c=null!==(t=this.lexerConfig.functionMapping[n])&&void 0!==t?t:n;a=a.concat(c,"(")}else if(tokenMatcher(i,ColumnRange)){var h=_slicedToArray(i.image.split(":"),2),l=h[0],p=h[1],u=columnAddressFromString(this.sheetMapping,l,r),m=columnAddressFromString(this.sheetMapping,p,r);a=void 0===u||void 0===m?a.concat("!REF"):a.concat(u.hash(!0),":",m.hash(!0))}else if(tokenMatcher(i,RowRange)){var d=_slicedToArray(i.image.split(":"),2),g=d[0],f=d[1],y=rowAddressFromString(this.sheetMapping,g,r),A=rowAddressFromString(this.sheetMapping,f,r);a=void 0===y||void 0===A?a.concat("!REF"):a.concat(y.hash(!0),":",A.hash(!0))}else a=a.concat(i.image);s++}return a}},{key:"rememberNewAst",value:function(e){var r=this.computeHashFromAst(e);return this.cache.maybeSetAndThenGet(r,e)}},{key:"computeHashFromAst",value:function(e){return"="+this.computeHashOfAstNode(e)}},{key:"destroy",value:function(){this.cache.destroy()}},{key:"computeHashOfAstNode",value:function(e){var r=this;switch(e.type){case AstNodeType.EMPTY:return e.leadingWhitespace||"";case AstNodeType.NUMBER:return imageWithWhitespace(formatNumber(e.value,this.config.decimalSeparator),e.leadingWhitespace);case AstNodeType.STRING:return imageWithWhitespace('"'+e.value+'"',e.leadingWhitespace);case AstNodeType.NAMED_EXPRESSION:return imageWithWhitespace(e.expressionName,e.leadingWhitespace);case AstNodeType.FUNCTION_CALL:var t=e.args.map(function(e){return r.computeHashOfAstNode(e)}).join(this.config.functionArgSeparator),a=e.procedureName+"("+t+imageWithWhitespace(")",e.internalWhitespace);return imageWithWhitespace(a,e.leadingWhitespace);case AstNodeType.CELL_REFERENCE:return imageWithWhitespace(e.reference.hash(!0),e.leadingWhitespace);case AstNodeType.COLUMN_RANGE:case AstNodeType.ROW_RANGE:case AstNodeType.CELL_RANGE:var s=e.start.hash(e.sheetReferenceType!==RangeSheetReferenceType.RELATIVE),i=e.end.hash(e.sheetReferenceType===RangeSheetReferenceType.BOTH_ABSOLUTE);return imageWithWhitespace(s+":"+i,e.leadingWhitespace);case AstNodeType.MINUS_UNARY_OP:return imageWithWhitespace("-"+this.computeHashOfAstNode(e.value),e.leadingWhitespace);case AstNodeType.PLUS_UNARY_OP:return imageWithWhitespace("+"+this.computeHashOfAstNode(e.value),e.leadingWhitespace);case AstNodeType.PERCENT_OP:return this.computeHashOfAstNode(e.value)+imageWithWhitespace("%",e.leadingWhitespace);case AstNodeType.ERROR:var o=this.config.translationPackage.getErrorTranslation(e.error?e.error.type:ErrorType.ERROR);return imageWithWhitespace(o,e.leadingWhitespace);case AstNodeType.ERROR_WITH_RAW_INPUT:return imageWithWhitespace(e.rawInput,e.leadingWhitespace);case AstNodeType.PARENTHESIS:var n="("+this.computeHashOfAstNode(e.expression)+imageWithWhitespace(")",e.internalWhitespace);return imageWithWhitespace(n,e.leadingWhitespace);default:return this.computeHashOfAstNode(e.left)+imageWithWhitespace(binaryOpTokenMap[e.type],e.leadingWhitespace)+this.computeHashOfAstNode(e.right)}}}]),e}();export function bindWhitespacesToTokens(e){var r=[],t=e[0];tokenMatcher(t,WhiteSpace)||r.push(t);for(var a=1;a<e.length;++a){var s=e[a];if(!tokenMatcher(s,WhiteSpace)){var i=e[a-1];tokenMatcher(i,WhiteSpace)&&(s.leadingWhitespace=i),r.push(s)}}return r}
//# sourceMappingURL=/sm/002e0f30210c974fd92ff2792d96c6595821dff8b84da4ee2a70309be241a84c.map