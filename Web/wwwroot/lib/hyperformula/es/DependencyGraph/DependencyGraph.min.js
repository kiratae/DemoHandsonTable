/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/hyperformula@0.1.3/es/DependencyGraph/DependencyGraph.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import"core-js/modules/es.symbol";import"core-js/modules/es.symbol.description";import"core-js/modules/es.symbol.iterator";import"core-js/modules/es.array.concat";import"core-js/modules/es.array.for-each";import"core-js/modules/es.array.from";import"core-js/modules/es.array.iterator";import"core-js/modules/es.array.map";import"core-js/modules/es.array.slice";import"core-js/modules/es.function.name";import"core-js/modules/es.object.to-string";import"core-js/modules/es.regexp.to-string";import"core-js/modules/es.set";import"core-js/modules/es.string.iterator";import"core-js/modules/web.dom-collections.for-each";import"core-js/modules/web.dom-collections.iterator";import"regenerator-runtime/runtime";function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_unsupportedIterableToArray(e,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,r){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var t=[],a=!0,n=!1,s=void 0;try{for(var i,o=e[Symbol.iterator]();!(a=(i=o.next()).done)&&(t.push(i.value),!r||t.length!==r);a=!0);}catch(e){n=!0,s=e}finally{try{a||null==o.return||o.return()}finally{if(n)throw s}}return t}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _createForOfIteratorHelper(e,r){var t;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(t=_unsupportedIterableToArray(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var a=0,n=function(){};return{s:n,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,i=!0,o=!1;return{s:function(){t=e[Symbol.iterator]()},n:function(){var e=t.next();return i=e.done,e},e:function(e){o=!0,s=e},f:function(){try{i||null==t.return||t.return()}finally{if(o)throw s}}}}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,r):void 0}}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,a=new Array(r);t<r;t++)a[t]=e[t];return a}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var a=r[t];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),e}import assert from"assert";import{AbsoluteCellRange}from"../AbsoluteCellRange";import{absolutizeDependencies}from"../absolutizeDependencies";import{CellError,EmptyValue,ErrorType,simpleCellAddress}from"../Cell";import{collectDependencies,NamedExpressionDependency}from"../parser";import{ColumnsSpan,RowsSpan}from"../Span";import{StatType}from"../statistics";import{EmptyCellVertex,FormulaCellVertex,MatrixVertex,RangeVertex,ValueCellVertex}from"./";import{AddressMapping}from"./AddressMapping/AddressMapping";import{collectAddressesDependentToMatrix}from"./collectAddressesDependentToMatrix";import{Graph}from"./Graph";import{MatrixMapping}from"./MatrixMapping";import{RangeMapping}from"./RangeMapping";import{SheetMapping}from"./SheetMapping";import{SimpleRangeValue}from"../interpreter/InterpreterValue";export var DependencyGraph=function(){function e(r,t,a,n,s,i,o,l){var c=this;_classCallCheck(this,e),this.addressMapping=r,this.rangeMapping=t,this.sheetMapping=a,this.matrixMapping=n,this.stats=s,this.lazilyTransformingAstService=i,this.functionRegistry=o,this.namedExpressions=l,this.dependencyQuery=function(e){var r,t;if(e instanceof FormulaCellVertex)t=e.getAddress(c.lazilyTransformingAstService),r=e.getFormula(c.lazilyTransformingAstService);else{if(!(e instanceof MatrixVertex&&e.isFormula())){if(e instanceof RangeVertex){var a,n=new Set,s=c.rangeMapping.findSmallerRange(e.range),i=s.smallerRangeVertex,o=s.restRange;null!==i&&c.graph.adjacentNodes(i).has(e)?(a=o,n.add(i)):a=e.range;var l,d=_createForOfIteratorHelper(a.addresses(c));try{for(d.s();!(l=d.n()).done;){var p=l.value,h=c.addressMapping.getCell(p);h instanceof EmptyCellVertex&&(h.address=p),null!==h&&n.add(h)}}catch(e){d.e(e)}finally{d.f()}return n}return null}t=e.getAddress(),r=e.getFormula()}var u=collectDependencies(r,c.functionRegistry),f=absolutizeDependencies(u,t);return new Set(f.map(function(e){if(e instanceof AbsoluteCellRange)return c.rangeMapping.fetchRange(e.start,e.end);if(e instanceof NamedExpressionDependency){var r=c.namedExpressions.namedExpressionOrPlaceholder(e.name,t.sheet);return c.addressMapping.fetchCell(r.address)}return c.addressMapping.fetchCell(e)}))},this.graph=new Graph(this.dependencyQuery)}return _createClass(e,[{key:"setFormulaToCell",value:function(e,r,t,a,n){var s=this.addressMapping.getCell(e);this.ensureThatVertexIsNonMatrixCellVertex(s);var i=new FormulaCellVertex(r,e,this.lazilyTransformingAstService.version());this.exchangeOrAddGraphNode(s,i),this.addressMapping.setCell(e,i),this.processCellDependencies(t,i),this.graph.markNodeAsSpecialRecentlyChanged(i),a&&this.markAsVolatile(i),n&&this.markAsDependentOnStructureChange(i),this.correctInfiniteRangesDependency(e)}},{key:"setParsingErrorToCell",value:function(e,r){var t=this.addressMapping.getCell(e);this.ensureThatVertexIsNonMatrixCellVertex(t),this.exchangeOrAddGraphNode(t,r),this.addressMapping.setCell(e,r),this.graph.markNodeAsSpecialRecentlyChanged(r),this.correctInfiniteRangesDependency(e)}},{key:"setValueToCell",value:function(e,r){var t=this.addressMapping.getCell(e);if(this.ensureThatVertexIsNonMatrixCellVertex(t),t instanceof ValueCellVertex){t.getCellValue()!==r&&(t.setCellValue(r),this.graph.markNodeAsSpecialRecentlyChanged(t))}else{var a=new ValueCellVertex(r);this.exchangeOrAddGraphNode(t,a),this.addressMapping.setCell(e,a),this.graph.markNodeAsSpecialRecentlyChanged(a)}this.correctInfiniteRangesDependency(e)}},{key:"setCellEmpty",value:function(e){var r=this.addressMapping.getCell(e);if(null!==r)if(this.ensureThatVertexIsNonMatrixCellVertex(r),this.graph.adjacentNodes(r).size>0){var t=new EmptyCellVertex(e);this.exchangeGraphNode(r,t),0===this.graph.adjacentNodesCount(t)?(this.removeVertex(t),this.addressMapping.removeCell(e)):(this.graph.markNodeAsSpecialRecentlyChanged(t),this.addressMapping.setCell(e,t))}else this.removeVertex(r),this.addressMapping.removeCell(e)}},{key:"ensureThatVertexIsNonMatrixCellVertex",value:function(e){assert.ok(!(e instanceof MatrixVertex),"Illegal operation")}},{key:"clearRecentlyChangedVertices",value:function(){this.graph.clearSpecialNodesRecentlyChanged()}},{key:"verticesToRecompute",value:function(){return new Set([].concat(_toConsumableArray(this.graph.specialNodesRecentlyChanged),_toConsumableArray(this.volatileVertices())))}},{key:"processCellDependencies",value:function(e,r){var t=this;e.forEach(function(e){if(e instanceof AbsoluteCellRange){var a=e,n=t.getRange(a.start,a.end);void 0===n&&(n=new RangeVertex(a),t.rangeMapping.setRange(n)),t.graph.addNode(n),a.isFinite()||t.graph.markNodeAsInfiniteRange(n);var s=t.rangeMapping.findSmallerRange(a),i=s.smallerRangeVertex,o=s.restRange;if(i){if(t.graph.addEdge(i,n),n.bruteForce){n.bruteForce=!1;var l,c=_createForOfIteratorHelper(a.addresses(t));try{for(c.s();!(l=c.n()).done;){var d=l.value;t.graph.removeEdge(t.fetchCell(d),n)}}catch(e){c.e(e)}finally{c.f()}}}else n.bruteForce=!0;var p=t.matrixMapping.getMatrix(o);if(void 0!==p)t.graph.addEdge(p,n);else{var h,u=_createForOfIteratorHelper(o.addresses(t));try{for(u.s();!(h=u.n()).done;){var f=h.value;t.graph.addEdge(t.fetchCellOrCreateEmpty(f),n)}}catch(e){u.e(e)}finally{u.f()}}t.graph.addEdge(n,r),a.isFinite()&&t.correctInfiniteRangesDependenciesByRangeVertex(n)}else if(e instanceof NamedExpressionDependency){var g=r.getAddress(t.lazilyTransformingAstService).sheet,m=t.fetchNamedExpressionVertex(e.name,g);t.graph.addEdge(m,r)}else t.graph.addEdge(t.fetchCellOrCreateEmpty(e),r)})}},{key:"fetchNamedExpressionVertex",value:function(e,r){var t=this.namedExpressions.namedExpressionOrPlaceholder(e,r);return this.fetchCellOrCreateEmpty(t.address)}},{key:"exchangeNode",value:function(e,r){var t=this.fetchCellOrCreateEmpty(e),a=this.fetchCellOrCreateEmpty(r);this.addressMapping.removeCell(e),this.exchangeGraphNode(t,a)}},{key:"correctInfiniteRangesDependenciesByRangeVertex",value:function(e){var r,t=_createForOfIteratorHelper(this.graph.infiniteRanges);try{for(t.s();!(r=t.n()).done;){var a=r.value,n=a,s=e.range.intersectionWith(n.range);if(null!==s){var i,o=_createForOfIteratorHelper(s.addresses(this));try{for(o.s();!(i=o.n()).done;){var l=i.value;this.graph.addEdge(this.fetchCellOrCreateEmpty(l),a)}}catch(e){o.e(e)}finally{o.f()}}}}catch(e){t.e(e)}finally{t.f()}}},{key:"correctInfiniteRangesDependency",value:function(e){var r,t=null,a=_createForOfIteratorHelper(this.graph.infiniteRanges);try{for(a.s();!(r=a.n()).done;){var n=r.value;n.range.addressInRange(e)&&(t=t||this.fetchCellOrCreateEmpty(e),this.graph.addEdge(t,n))}}catch(e){a.e(e)}finally{a.f()}}},{key:"fetchCellOrCreateEmpty",value:function(e){var r=this.addressMapping.getCell(e);return r||(r=new EmptyCellVertex(e),this.graph.addNode(r),this.addressMapping.setCell(e,r)),r}},{key:"removeRows",value:function(e){var r=this;if(this.matrixMapping.isFormulaMatrixInRows(e))throw Error("It is not possible to remove row with matrix");this.stats.measure(StatType.ADJUSTING_GRAPH,function(){var t,a=_createForOfIteratorHelper(r.addressMapping.verticesFromRowsSpan(e));try{for(a.s();!(t=a.n()).done;){var n,s=t.value,i=_createForOfIteratorHelper(r.graph.adjacentNodes(s));try{for(i.s();!(n=i.n()).done;){var o=n.value;r.graph.markNodeAsSpecialRecentlyChanged(o)}}catch(e){i.e(e)}finally{i.f()}s instanceof MatrixVertex||r.removeVertex(s)}}catch(e){a.e(e)}finally{a.f()}}),this.stats.measure(StatType.ADJUSTING_MATRIX_MAPPING,function(){r.truncateMatricesAfterRemovingRows(e)}),this.stats.measure(StatType.ADJUSTING_ADDRESS_MAPPING,function(){r.addressMapping.removeRows(e)}),this.stats.measure(StatType.ADJUSTING_RANGES,function(){r.truncateRanges(e,function(e){return e.row})}),this.addStructuralNodesToChangeSet()}},{key:"removeSheet",value:function(e){var r,t=this,a=new Set,n=_createForOfIteratorHelper(this.addressMapping.sheetEntries(e));try{for(n.s();!(r=n.n()).done;){var s=_slicedToArray(r.value,2),i=s[0],o=s[1];if(o instanceof MatrixVertex){if(a.has(o))continue;a.add(o)}var l,c=_createForOfIteratorHelper(this.graph.adjacentNodes(o));try{for(c.s();!(l=c.n()).done;){var d=l.value;this.graph.markNodeAsSpecialRecentlyChanged(d)}}catch(e){c.e(e)}finally{c.f()}this.removeVertex(o),this.addressMapping.removeCell(i)}}catch(e){n.e(e)}finally{n.f()}this.stats.measure(StatType.ADJUSTING_MATRIX_MAPPING,function(){var e,r=_createForOfIteratorHelper(a.values());try{for(r.s();!(e=r.n()).done;){var n=e.value;t.matrixMapping.removeMatrix(n.getRange())}}catch(e){r.e(e)}finally{r.f()}}),this.stats.measure(StatType.ADJUSTING_RANGES,function(){var r,a=_createForOfIteratorHelper(t.rangeMapping.removeRangesInSheet(e));try{for(a.s();!(r=a.n()).done;){var n=r.value;t.removeVertex(n)}}catch(e){a.e(e)}finally{a.f()}t.stats.measure(StatType.ADJUSTING_ADDRESS_MAPPING,function(){t.addressMapping.removeSheet(e)})}),this.addStructuralNodesToChangeSet()}},{key:"clearSheet",value:function(e){var r,t=new Set,a=_createForOfIteratorHelper(this.addressMapping.sheetEntries(e));try{for(a.s();!(r=a.n()).done;){var n=_slicedToArray(r.value,2),s=n[0],i=n[1];i instanceof MatrixVertex?t.add(i):this.setCellEmpty(s)}}catch(e){a.e(e)}finally{a.f()}var o,l=_createForOfIteratorHelper(t.values());try{for(l.s();!(o=l.n()).done;){var c=o.value;this.setMatrixEmpty(c)}}catch(e){l.e(e)}finally{l.f()}this.addStructuralNodesToChangeSet()}},{key:"removeColumns",value:function(e){var r=this;if(this.matrixMapping.isFormulaMatrixInColumns(e))throw Error("It is not possible to remove column within matrix");this.stats.measure(StatType.ADJUSTING_GRAPH,function(){var t,a=_createForOfIteratorHelper(r.addressMapping.verticesFromColumnsSpan(e));try{for(a.s();!(t=a.n()).done;){var n,s=t.value,i=_createForOfIteratorHelper(r.graph.adjacentNodes(s));try{for(i.s();!(n=i.n()).done;){var o=n.value;r.graph.markNodeAsSpecialRecentlyChanged(o)}}catch(e){i.e(e)}finally{i.f()}s instanceof MatrixVertex||r.removeVertex(s)}}catch(e){a.e(e)}finally{a.f()}}),this.stats.measure(StatType.ADJUSTING_MATRIX_MAPPING,function(){r.truncateMatricesAfterRemovingColumns(e)}),this.stats.measure(StatType.ADJUSTING_ADDRESS_MAPPING,function(){r.addressMapping.removeColumns(e)}),this.stats.measure(StatType.ADJUSTING_RANGES,function(){r.truncateRanges(e,function(e){return e.col})}),this.addStructuralNodesToChangeSet()}},{key:"addRows",value:function(e){var r=this;this.stats.measure(StatType.ADJUSTING_ADDRESS_MAPPING,function(){r.addressMapping.addRows(e.sheet,e.rowStart,e.numberOfRows)}),this.stats.measure(StatType.ADJUSTING_MATRIX_MAPPING,function(){r.expandMatricesAfterAddingRows(e.sheet,e.rowStart,e.numberOfRows)}),this.stats.measure(StatType.ADJUSTING_RANGES,function(){r.rangeMapping.moveAllRangesInSheetAfterRowByRows(e.sheet,e.rowStart,e.numberOfRows),r.fixRangesWhenAddingRows(e.sheet,e.rowStart,e.numberOfRows)});var t,a=_createForOfIteratorHelper(this.addressMapping.verticesFromRowsSpan(e));try{for(a.s();!(t=a.n()).done;){var n=t.value;this.graph.markNodeAsSpecialRecentlyChanged(n)}}catch(e){a.e(e)}finally{a.f()}this.addStructuralNodesToChangeSet()}},{key:"addColumns",value:function(e){var r=this;this.stats.measure(StatType.ADJUSTING_ADDRESS_MAPPING,function(){r.addressMapping.addColumns(e.sheet,e.columnStart,e.numberOfColumns)}),this.stats.measure(StatType.ADJUSTING_MATRIX_MAPPING,function(){r.expandMatricesAfterAddingColumns(e.sheet,e.columnStart,e.numberOfColumns)}),this.stats.measure(StatType.ADJUSTING_RANGES,function(){r.rangeMapping.moveAllRangesInSheetAfterColumnByColumns(e.sheet,e.columnStart,e.numberOfColumns),r.fixRangesWhenAddingColumns(e.sheet,e.columnStart,e.numberOfColumns)});var t,a=_createForOfIteratorHelper(this.addressMapping.verticesFromColumnsSpan(e));try{for(a.s();!(t=a.n()).done;){var n=t.value;this.graph.markNodeAsSpecialRecentlyChanged(n)}}catch(e){a.e(e)}finally{a.f()}this.addStructuralNodesToChangeSet()}},{key:"ensureNoMatrixInRange",value:function(e){if(this.matrixMapping.isFormulaMatrixInRange(e))throw Error("It is not possible to move / replace cells with matrix")}},{key:"moveCells",value:function(e,r,t,a){var n,s=_createForOfIteratorHelper(e.addressesWithDirection(r,t,this));try{for(s.s();!(n=s.n()).done;){var i=n.value,o=simpleCellAddress(a,i.col+r,i.row+t),l=this.addressMapping.getCell(i),c=this.addressMapping.getCell(o);if(this.addressMapping.removeCell(i),null!==l){this.graph.markNodeAsSpecialRecentlyChanged(l),this.addressMapping.setCell(o,l);var d,p=null,h=_createForOfIteratorHelper(this.graph.adjacentNodes(l));try{for(h.s();!(d=h.n()).done;){var u=d.value;u instanceof RangeVertex&&!e.containsRange(u.range)&&(p=p||this.fetchCellOrCreateEmpty(i),this.graph.addEdge(p,u),this.graph.removeEdge(l,u))}}catch(e){h.e(e)}finally{h.f()}p&&(this.graph.markNodeAsSpecialRecentlyChanged(p),this.addressMapping.setCell(i,p))}if(null!==c){null===l&&this.addressMapping.removeCell(o);var f,g=_createForOfIteratorHelper(this.graph.adjacentNodes(c));try{for(g.s();!(f=g.n()).done;){var m=f.value;m!==l&&(l=l||this.fetchCellOrCreateEmpty(o),this.graph.addEdge(l,m),this.graph.markNodeAsSpecialRecentlyChanged(l))}}catch(e){g.e(e)}finally{g.f()}this.removeVertex(c)}}}catch(e){s.e(e)}finally{s.f()}var v,y=_createForOfIteratorHelper(this.rangeMapping.rangeVerticesContainedInRange(e));try{for(y.s();!(v=y.n()).done;){var x,C=v.value,A=_createForOfIteratorHelper(this.graph.adjacentNodes(C));try{for(A.s();!(x=A.n()).done;){var M=x.value;if(M instanceof RangeVertex&&!e.containsRange(M.range)){this.graph.removeEdge(C,M);var R,S=_createForOfIteratorHelper(C.range.addresses(this));try{for(S.s();!(R=S.n()).done;){var I=R.value,k=this.fetchCellOrCreateEmpty(I);this.graph.addEdge(k,M),this.addressMapping.setCell(I,k),this.graph.markNodeAsSpecialRecentlyChanged(k)}}catch(e){S.e(e)}finally{S.f()}}}}catch(e){A.e(e)}finally{A.f()}}}catch(e){y.e(e)}finally{y.f()}this.rangeMapping.moveRangesInsideSourceRange(e,r,t,a)}},{key:"disableNumericMatrices",value:function(){var e,r=_createForOfIteratorHelper(this.matrixMapping.numericMatrices());try{for(r.s();!(e=r.n()).done;){var t=_slicedToArray(e.value,2),a=(t[0],t[1]);this.breakNumericMatrix(a)}}catch(e){r.e(e)}finally{r.f()}}},{key:"breakNumericMatricesInRange",value:function(e){var r,t=_createForOfIteratorHelper(this.matrixMapping.numericMatricesInRange(e));try{for(t.s();!(r=t.n()).done;){var a=_slicedToArray(r.value,2),n=(a[0],a[1]);this.breakNumericMatrix(n)}}catch(e){t.e(e)}finally{t.f()}}},{key:"breakNumericMatrix",value:function(e){var r,t=AbsoluteCellRange.spanFrom(e.getAddress(),e.width,e.height),a=this.graph.adjacentNodes(e),n=_createForOfIteratorHelper(t.addresses(this));try{for(n.s();!(r=n.n()).done;){var s=r.value,i=this.getCellValue(s),o=new ValueCellVertex(i);this.addVertex(s,o)}}catch(e){n.e(e)}finally{n.f()}var l,c=_createForOfIteratorHelper(a.values());try{for(c.s();!(l=c.n()).done;){var d,p=l.value,h=_createForOfIteratorHelper(collectAddressesDependentToMatrix(this.functionRegistry,p,e,this.lazilyTransformingAstService,this));try{for(h.s();!(d=h.n()).done;){var u=d.value,f=this.fetchCell(u);this.graph.addEdge(f,p)}}catch(e){h.e(e)}finally{h.f()}}}catch(e){c.e(e)}finally{c.f()}this.removeVertex(e),this.matrixMapping.removeMatrix(e.getRange())}},{key:"setMatrixEmpty",value:function(e){var r,t=AbsoluteCellRange.spanFrom(e.getAddress(),e.width,e.height),a=this.graph.adjacentNodes(e),n=_createForOfIteratorHelper(t.addresses(this));try{for(n.s();!(r=n.n()).done;){var s=r.value;this.addressMapping.removeCell(s)}}catch(e){n.e(e)}finally{n.f()}var i,o=_createForOfIteratorHelper(a.values());try{for(o.s();!(i=o.n()).done;){var l,c=i.value,d=collectAddressesDependentToMatrix(this.functionRegistry,c,e,this.lazilyTransformingAstService,this),p=_createForOfIteratorHelper(d);try{for(p.s();!(l=p.n()).done;){var h=l.value,u=this.fetchCellOrCreateEmpty(h);this.graph.addEdge(u,c)}}catch(e){p.e(e)}finally{p.f()}d.length>0&&this.graph.markNodeAsSpecialRecentlyChanged(c)}}catch(e){o.e(e)}finally{o.f()}this.removeVertex(e),this.matrixMapping.removeMatrix(e.getRange())}},{key:"addVertex",value:function(e,r){this.graph.addNode(r),this.setVertexAddress(e,r)}},{key:"addMatrixVertex",value:function(e,r){this.graph.addNode(r),this.setAddressMappingForMatrixVertex(r,e)}},{key:"addNewMatrixVertex",value:function(e){var r,t=AbsoluteCellRange.spanFrom(e.getAddress(),e.width,e.height),a=_createForOfIteratorHelper(this.verticesFromRange(t));try{for(a.s();!(r=a.n()).done;){if(r.value instanceof MatrixVertex)throw Error("You cannot modify only part of an array")}}catch(e){a.e(e)}finally{a.f()}this.setMatrix(t,e);var n,s=_createForOfIteratorHelper(this.entriesFromRange(t));try{for(s.s();!(n=s.n()).done;){var i=_slicedToArray(n.value,2),o=i[0],l=i[1];l&&this.exchangeGraphNode(l,e),this.setVertexAddress(o,e)}}catch(e){s.e(e)}finally{s.f()}}},{key:"matrixFormulaNodes",value:regeneratorRuntime.mark(function e(){var r,t,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r=_createForOfIteratorHelper(this.graph.nodes),e.prev=1,r.s();case 3:if((t=r.n()).done){e.next=10;break}if(!((a=t.value)instanceof MatrixVertex&&a.isFormula())){e.next=8;break}return e.next=8,a;case 8:e.next=3;break;case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(1),r.e(e.t0);case 15:return e.prev=15,r.f(),e.finish(15);case 18:case"end":return e.stop()}},e,this,[[1,12,15,18]])})},{key:"entriesFromRowsSpan",value:regeneratorRuntime.mark(function e(r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.addressMapping.entriesFromRowsSpan(r),"t0",1);case 1:case"end":return e.stop()}},e,this)})},{key:"entriesFromColumnsSpan",value:regeneratorRuntime.mark(function e(r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.delegateYield(this.addressMapping.entriesFromColumnsSpan(r),"t0",1);case 1:case"end":return e.stop()}},e,this)})},{key:"existsVertex",value:function(e){return this.addressMapping.has(e)}},{key:"fetchCell",value:function(e){return this.addressMapping.fetchCell(e)}},{key:"getCell",value:function(e){return this.addressMapping.getCell(e)}},{key:"getCellValue",value:function(e){return this.addressMapping.getCellValue(e)}},{key:"getScalarValue",value:function(e){var r=this.addressMapping.getCellValue(e);return r instanceof SimpleRangeValue?new CellError(ErrorType.VALUE):r}},{key:"setVertexAddress",value:function(e,r){this.addressMapping.setCell(e,r)}},{key:"existsEdge",value:function(e,r){return this.graph.existsEdge(e,r)}},{key:"getSheetId",value:function(e){return this.sheetMapping.fetch(e)}},{key:"getSheetName",value:function(e){return this.sheetMapping.fetchDisplayName(e)}},{key:"getSheetHeight",value:function(e){return this.addressMapping.getHeight(e)}},{key:"getSheetWidth",value:function(e){return this.addressMapping.getWidth(e)}},{key:"getMatrix",value:function(e){return this.matrixMapping.getMatrix(e)}},{key:"setMatrix",value:function(e,r){this.matrixMapping.setMatrix(e,r)}},{key:"getRange",value:function(e,r){return this.rangeMapping.getRange(e,r)}},{key:"topSortWithScc",value:function(){return this.graph.topSortWithScc()}},{key:"markAsVolatile",value:function(e){this.graph.markNodeAsSpecial(e)}},{key:"markAsDependentOnStructureChange",value:function(e){this.graph.markNodeAsChangingWithStructure(e)}},{key:"forceApplyPostponedTransformations",value:function(){var e,r=_createForOfIteratorHelper(this.graph.nodes.values());try{for(r.s();!(e=r.n()).done;){var t=e.value;t instanceof FormulaCellVertex&&t.ensureRecentData(this.lazilyTransformingAstService)}}catch(e){r.e(e)}finally{r.f()}}},{key:"volatileVertices",value:function(){return this.graph.specialNodes}},{key:"destroy",value:function(){this.graph.destroy(),this.addressMapping.destroy(),this.rangeMapping.destroy(),this.sheetMapping.destroy(),this.matrixMapping.destroy()}},{key:"verticesFromRange",value:regeneratorRuntime.mark(function e(r){var t,a,n,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=_createForOfIteratorHelper(r.addresses(this)),e.prev=1,t.s();case 3:if((a=t.n()).done){e.next=11;break}if(n=a.value,!(s=this.getCell(n))){e.next=9;break}return e.next=9,s;case 9:e.next=3;break;case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(1),t.e(e.t0);case 16:return e.prev=16,t.f(),e.finish(16);case 19:case"end":return e.stop()}},e,this,[[1,13,16,19]])})},{key:"valuesFromRange",value:regeneratorRuntime.mark(function e(r){var t,a,n,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=_createForOfIteratorHelper(r.addresses(this)),e.prev=1,t.s();case 3:if((a=t.n()).done){e.next=11;break}if(n=a.value,(s=this.getScalarValue(n))===EmptyValue){e.next=9;break}return e.next=9,[s,n];case 9:e.next=3;break;case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(1),t.e(e.t0);case 16:return e.prev=16,t.f(),e.finish(16);case 19:case"end":return e.stop()}},e,this,[[1,13,16,19]])})},{key:"entriesFromRange",value:regeneratorRuntime.mark(function e(r){var t,a,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:t=_createForOfIteratorHelper(r.addresses(this)),e.prev=1,t.s();case 3:if((a=t.n()).done){e.next=9;break}return n=a.value,e.next=7,[n,this.getCell(n)];case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t.e(e.t0);case 14:return e.prev=14,t.f(),e.finish(14);case 17:case"end":return e.stop()}},e,this,[[1,11,14,17]])})},{key:"exchangeGraphNode",value:function(e,r){var t=this;this.graph.addNode(r);var a=this.graph.adjacentNodes(e);this.removeVertex(e),a.forEach(function(e){t.graph.hasNode(e)&&t.graph.addEdge(r,e)})}},{key:"exchangeOrAddGraphNode",value:function(e,r){e?this.exchangeGraphNode(e,r):this.graph.addNode(r)}},{key:"addStructuralNodesToChangeSet",value:function(){var e,r=_createForOfIteratorHelper(this.graph.specialNodesStructuralChanges);try{for(r.s();!(e=r.n()).done;){var t=e.value;this.graph.markNodeAsSpecialRecentlyChanged(t)}}catch(e){r.e(e)}finally{r.f()}}},{key:"fixRangesWhenAddingRows",value:function(e,r,t){for(var a=0,n=Array.from(this.rangeMapping.rangesInSheet(e));a<n.length;a++){var s=n[a];if(s.range.includesRow(r+t))if(s.bruteForce){var i,o=_createForOfIteratorHelper(s.range.rangeWithSameWidth(r,t).addresses(this));try{for(o.s();!(i=o.n()).done;){var l=i.value;this.graph.addEdge(this.fetchCellOrCreateEmpty(l),s)}}catch(e){o.e(e)}finally{o.f()}}else{var c=s,d=this.rangeMapping.findSmallerRange(c.range);if(null!==d.smallerRangeVertex)continue;for(;null===d.smallerRangeVertex;){var p=new RangeVertex(AbsoluteCellRange.spanFrom(c.range.start,c.range.width(),c.range.height()-1));this.rangeMapping.setRange(p),this.graph.addNode(p);var h=new AbsoluteCellRange(simpleCellAddress(c.range.start.sheet,c.range.start.col,c.range.end.row),c.range.end);this.addAllFromRange(h,c),this.graph.addEdge(p,c),c=p,d=this.rangeMapping.findSmallerRange(c.range)}this.graph.addEdge(d.smallerRangeVertex,c),this.addAllFromRange(d.restRange,c),this.graph.removeEdge(d.smallerRangeVertex,s)}}}},{key:"addAllFromRange",value:function(e,r){var t,a=_createForOfIteratorHelper(e.addresses(this));try{for(a.s();!(t=a.n()).done;){var n=t.value;this.graph.addEdge(this.fetchCellOrCreateEmpty(n),r)}}catch(e){a.e(e)}finally{a.f()}}},{key:"fixRangesWhenAddingColumns",value:function(e,r,t){var a,n=_createForOfIteratorHelper(this.rangeMapping.rangesInSheet(e));try{for(n.s();!(a=n.n()).done;){var s=a.value;if(s.range.includesColumn(r+t)){var i,o=_createForOfIteratorHelper((s.bruteForce?s.range.rangeWithSameHeight(r,t):AbsoluteCellRange.spanFrom(simpleCellAddress(e,r,s.range.end.row),t,1)).addresses(this));try{for(o.s();!(i=o.n()).done;){var l=i.value;this.graph.addEdge(this.fetchCellOrCreateEmpty(l),s)}}catch(e){o.e(e)}finally{o.f()}}}}catch(e){n.e(e)}finally{n.f()}}},{key:"setAddressMappingForMatrixVertex",value:function(e,r){if(this.setVertexAddress(r,e),e instanceof MatrixVertex){var t=AbsoluteCellRange.spanFrom(r,e.width,e.height);this.setMatrix(t,e);var a,n=_createForOfIteratorHelper(t.addresses(this));try{for(n.s();!(a=n.n()).done;){var s=a.value;this.setVertexAddress(s,e)}}catch(e){n.e(e)}finally{n.f()}}}},{key:"truncateMatricesAfterRemovingRows",value:function(e){var r=this;this.matrixMapping.truncateMatricesByRows(e).forEach(function(e){r.removeVertex(e)})}},{key:"truncateRanges",value:function(e,r){var t,a=this.rangeMapping.truncateRanges(e,r),n=a.verticesToRemove,s=_createForOfIteratorHelper(a.verticesToMerge);try{for(s.s();!(t=s.n()).done;){var i=_slicedToArray(t.value,2),o=i[0],l=i[1];this.mergeRangeVertices(o,l)}}catch(e){s.e(e)}finally{s.f()}var c,d=_createForOfIteratorHelper(n);try{for(d.s();!(c=d.n()).done;){var p=c.value;this.removeVertexAndCleanupDependencies(p)}}catch(e){d.e(e)}finally{d.f()}}},{key:"truncateMatricesAfterRemovingColumns",value:function(e){var r=this;this.matrixMapping.truncateMatricesByColumns(e).forEach(function(e){r.removeVertex(e)})}},{key:"expandMatricesAfterAddingRows",value:function(e,r,t){var a,n=_createForOfIteratorHelper(this.matrixMapping.numericMatricesInRows(RowsSpan.fromRowStartAndEnd(e,r,r)));try{for(n.s();!(a=n.n()).done;){var s=_slicedToArray(a.value,2)[1];s.addRows(e,r,t);var i,o=_createForOfIteratorHelper(AbsoluteCellRange.spanFrom(simpleCellAddress(e,s.getAddress().col,r),s.width,t).addresses(this));try{for(o.s();!(i=o.n()).done;){var l=i.value;this.addressMapping.setCell(l,s)}}catch(e){o.e(e)}finally{o.f()}}}catch(e){n.e(e)}finally{n.f()}}},{key:"expandMatricesAfterAddingColumns",value:function(e,r,t){var a,n=_createForOfIteratorHelper(this.matrixMapping.numericMatricesInColumns(ColumnsSpan.fromColumnStartAndEnd(e,r,r)));try{for(n.s();!(a=n.n()).done;){var s=_slicedToArray(a.value,2)[1];s.addColumns(e,r,t);var i,o=_createForOfIteratorHelper(AbsoluteCellRange.spanFrom(simpleCellAddress(e,r,s.getAddress().row),t,s.height).addresses(this));try{for(o.s();!(i=o.n()).done;){var l=i.value;this.addressMapping.setCell(l,s)}}catch(e){o.e(e)}finally{o.f()}}}catch(e){n.e(e)}finally{n.f()}}},{key:"removeVertex",value:function(e){this.removeVertexAndCleanupDependencies(e),e instanceof RangeVertex&&this.rangeMapping.removeRange(e)}},{key:"mergeRangeVertices",value:function(e,r){var t=this,a=this.graph.adjacentNodes(r);this.removeVertexAndCleanupDependencies(r),this.graph.softRemoveEdge(e,r),a.forEach(function(r){t.graph.hasNode(r)&&t.graph.addEdge(e,r)})}},{key:"removeVertexAndCleanupDependencies",value:function(e){for(var r=this.graph.removeNode(e);r.size>0;){var t=r.values().next().value;r.delete(t),this.graph.hasNode(t)&&0===this.graph.adjacentNodesCount(t)&&((t instanceof RangeVertex||t instanceof EmptyCellVertex)&&this.graph.removeNode(t).forEach(function(e){return r.add(e)}),t instanceof RangeVertex?this.rangeMapping.removeRange(t):t instanceof EmptyCellVertex&&this.addressMapping.removeCell(t.address))}}}],[{key:"buildEmpty",value:function(r,t,a,n,s){return new e(new AddressMapping(t.chooseAddressMappingPolicy),new RangeMapping,new SheetMapping(t.translationPackage),new MatrixMapping,s,r,a,n)}}]),e}();
//# sourceMappingURL=/sm/4d96abcd1c74cf22020ee19ddf552f293b958bcace8b6c8cc461cc6c15ddf823.map