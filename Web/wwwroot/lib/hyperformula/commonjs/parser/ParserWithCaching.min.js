/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/hyperformula@0.1.3/commonjs/parser/ParserWithCaching.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";require("core-js/modules/es.symbol"),require("core-js/modules/es.symbol.description"),require("core-js/modules/es.symbol.iterator"),require("core-js/modules/es.array.concat"),require("core-js/modules/es.array.from"),require("core-js/modules/es.array.iterator"),require("core-js/modules/es.array.join"),require("core-js/modules/es.array.map"),require("core-js/modules/es.array.slice"),require("core-js/modules/es.function.name"),require("core-js/modules/es.object.assign"),require("core-js/modules/es.object.to-string"),require("core-js/modules/es.regexp.exec"),require("core-js/modules/es.regexp.to-string"),require("core-js/modules/es.string.iterator"),require("core-js/modules/es.string.split"),require("core-js/modules/web.dom-collections.iterator"),exports.__esModule=!0,exports.bindWhitespacesToTokens=bindWhitespacesToTokens,exports.ParserWithCaching=void 0;var _chevrotain=require("chevrotain"),_Cell=require("../Cell"),_=require("./"),_addressRepresentationConverters=require("./addressRepresentationConverters"),_Ast=require("./Ast"),_binaryOpTokenMap=require("./binaryOpTokenMap"),_Cache=require("./Cache"),_FormulaParser=require("./FormulaParser"),_LexerConfig=require("./LexerConfig"),_Unparser=require("./Unparser");function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_unsupportedIterableToArray(e,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,r):void 0}}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,s=new Array(r);t<r;t++)s[t]=e[t];return s}function _iterableToArrayLimit(e,r){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var t=[],s=!0,a=!1,i=void 0;try{for(var n,o=e[Symbol.iterator]();!(s=(n=o.next()).done)&&(t.push(n.value),!r||t.length!==r);s=!0);}catch(e){a=!0,i=e}finally{try{s||null==o.return||o.return()}finally{if(a)throw i}}return t}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var s=r[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),e}var ParserWithCaching=function(){function e(r,t,s){_classCallCheck(this,e),this.config=r,this.functionRegistry=t,this.sheetMapping=s,this.statsCacheUsed=0,this.lexerConfig=(0,_LexerConfig.buildLexerConfig)(r),this.lexer=new _FormulaParser.FormulaLexer(this.lexerConfig),this.formulaParser=new _FormulaParser.FormulaParser(this.lexerConfig,this.sheetMapping),this.cache=new _Cache.Cache(this.functionRegistry)}return _createClass(e,[{key:"parse",value:function(e,r){var t=this.lexer.tokenizeFormula(e);if(t.errors.length>0){var s=t.errors.map(function(e){return{type:_Ast.ParsingErrorType.LexingError,message:e.message}});return{ast:(0,_.buildParsingErrorAst)(),errors:s,hasVolatileFunction:!1,hasStructuralChangeFunction:!1,dependencies:[]}}var a=this.computeHashFromTokens(t.tokens,r),i=this.cache.get(a);if(i)++this.statsCacheUsed;else{var n=bindWhitespacesToTokens(t.tokens),o=this.formulaParser.parseFromTokens(n,r);if(o.errors.length>0)return Object.assign(Object.assign({},o),{hasVolatileFunction:!1,hasStructuralChangeFunction:!1,dependencies:[]});i=this.cache.set(a,o.ast)}var c=i;return{ast:c.ast,errors:[],hasVolatileFunction:c.hasVolatileFunction,hasStructuralChangeFunction:c.hasStructuralChangeFunction,dependencies:c.relativeDependencies}}},{key:"fetchCachedResultForAst",value:function(e){var r=this.computeHashFromAst(e);return this.fetchCachedResult(r)}},{key:"fetchCachedResult",value:function(e){var r=this.cache.get(e);if(null===r)throw new Error("There is no AST with such key in the cache");return{ast:r.ast,errors:[],hasVolatileFunction:r.hasVolatileFunction,hasStructuralChangeFunction:r.hasStructuralChangeFunction,dependencies:r.relativeDependencies}}},{key:"computeHashFromTokens",value:function(e,r){for(var t,s="",a=0;a<e.length;){var i=e[a];if((0,_chevrotain.tokenMatcher)(i,_LexerConfig.CellReference)){var n=(0,_addressRepresentationConverters.cellAddressFromString)(this.sheetMapping,i.image,r);s=void 0===n?s.concat(i.image):s.concat(n.hash(!0))}else if((0,_chevrotain.tokenMatcher)(i,_LexerConfig.ProcedureName)){var o=i.image.toUpperCase().slice(0,-1),c=null!==(t=this.lexerConfig.functionMapping[o])&&void 0!==t?t:o;s=s.concat(c,"(")}else if((0,_chevrotain.tokenMatcher)(i,_LexerConfig.ColumnRange)){var h=_slicedToArray(i.image.split(":"),2),u=h[0],l=h[1],p=(0,_addressRepresentationConverters.columnAddressFromString)(this.sheetMapping,u,r),d=(0,_addressRepresentationConverters.columnAddressFromString)(this.sheetMapping,l,r);s=void 0===p||void 0===d?s.concat("!REF"):s.concat(p.hash(!0),":",d.hash(!0))}else if((0,_chevrotain.tokenMatcher)(i,_LexerConfig.RowRange)){var g=_slicedToArray(i.image.split(":"),2),m=g[0],_=g[1],f=(0,_addressRepresentationConverters.rowAddressFromString)(this.sheetMapping,m,r),y=(0,_addressRepresentationConverters.rowAddressFromString)(this.sheetMapping,_,r);s=void 0===f||void 0===y?s.concat("!REF"):s.concat(f.hash(!0),":",y.hash(!0))}else s=s.concat(i.image);a++}return s}},{key:"rememberNewAst",value:function(e){var r=this.computeHashFromAst(e);return this.cache.maybeSetAndThenGet(r,e)}},{key:"computeHashFromAst",value:function(e){return"="+this.computeHashOfAstNode(e)}},{key:"destroy",value:function(){this.cache.destroy()}},{key:"computeHashOfAstNode",value:function(e){var r=this;switch(e.type){case _.AstNodeType.EMPTY:return e.leadingWhitespace||"";case _.AstNodeType.NUMBER:return(0,_Ast.imageWithWhitespace)((0,_Unparser.formatNumber)(e.value,this.config.decimalSeparator),e.leadingWhitespace);case _.AstNodeType.STRING:return(0,_Ast.imageWithWhitespace)('"'+e.value+'"',e.leadingWhitespace);case _.AstNodeType.NAMED_EXPRESSION:return(0,_Ast.imageWithWhitespace)(e.expressionName,e.leadingWhitespace);case _.AstNodeType.FUNCTION_CALL:var t=e.args.map(function(e){return r.computeHashOfAstNode(e)}).join(this.config.functionArgSeparator),s=e.procedureName+"("+t+(0,_Ast.imageWithWhitespace)(")",e.internalWhitespace);return(0,_Ast.imageWithWhitespace)(s,e.leadingWhitespace);case _.AstNodeType.CELL_REFERENCE:return(0,_Ast.imageWithWhitespace)(e.reference.hash(!0),e.leadingWhitespace);case _.AstNodeType.COLUMN_RANGE:case _.AstNodeType.ROW_RANGE:case _.AstNodeType.CELL_RANGE:var a=e.start.hash(e.sheetReferenceType!==_Ast.RangeSheetReferenceType.RELATIVE),i=e.end.hash(e.sheetReferenceType===_Ast.RangeSheetReferenceType.BOTH_ABSOLUTE);return(0,_Ast.imageWithWhitespace)(a+":"+i,e.leadingWhitespace);case _.AstNodeType.MINUS_UNARY_OP:return(0,_Ast.imageWithWhitespace)("-"+this.computeHashOfAstNode(e.value),e.leadingWhitespace);case _.AstNodeType.PLUS_UNARY_OP:return(0,_Ast.imageWithWhitespace)("+"+this.computeHashOfAstNode(e.value),e.leadingWhitespace);case _.AstNodeType.PERCENT_OP:return this.computeHashOfAstNode(e.value)+(0,_Ast.imageWithWhitespace)("%",e.leadingWhitespace);case _.AstNodeType.ERROR:var n=this.config.translationPackage.getErrorTranslation(e.error?e.error.type:_Cell.ErrorType.ERROR);return(0,_Ast.imageWithWhitespace)(n,e.leadingWhitespace);case _.AstNodeType.ERROR_WITH_RAW_INPUT:return(0,_Ast.imageWithWhitespace)(e.rawInput,e.leadingWhitespace);case _.AstNodeType.PARENTHESIS:var o="("+this.computeHashOfAstNode(e.expression)+(0,_Ast.imageWithWhitespace)(")",e.internalWhitespace);return(0,_Ast.imageWithWhitespace)(o,e.leadingWhitespace);default:return this.computeHashOfAstNode(e.left)+(0,_Ast.imageWithWhitespace)(_binaryOpTokenMap.binaryOpTokenMap[e.type],e.leadingWhitespace)+this.computeHashOfAstNode(e.right)}}}]),e}();function bindWhitespacesToTokens(e){var r=[],t=e[0];(0,_chevrotain.tokenMatcher)(t,_LexerConfig.WhiteSpace)||r.push(t);for(var s=1;s<e.length;++s){var a=e[s];if(!(0,_chevrotain.tokenMatcher)(a,_LexerConfig.WhiteSpace)){var i=e[s-1];(0,_chevrotain.tokenMatcher)(i,_LexerConfig.WhiteSpace)&&(a.leadingWhitespace=i),r.push(a)}}return r}exports.ParserWithCaching=ParserWithCaching;
//# sourceMappingURL=/sm/6793054f7233785e00e839d61c6d611d9879fdcef41d504097902d082082c7ae.map