/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/hyperformula@0.1.3/commonjs/Operations.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";require("core-js/modules/es.symbol"),require("core-js/modules/es.symbol.description"),require("core-js/modules/es.symbol.iterator"),require("core-js/modules/es.array.from"),require("core-js/modules/es.array.iterator"),require("core-js/modules/es.array.map"),require("core-js/modules/es.array.reduce"),require("core-js/modules/es.array.slice"),require("core-js/modules/es.array.sort"),require("core-js/modules/es.function.name"),require("core-js/modules/es.number.constructor"),require("core-js/modules/es.number.is-integer"),require("core-js/modules/es.object.to-string"),require("core-js/modules/es.regexp.to-string"),require("core-js/modules/es.string.iterator"),require("core-js/modules/web.dom-collections.iterator"),exports.__esModule=!0,exports.normalizeRemovedIndexes=normalizeRemovedIndexes,exports.normalizeAddedIndexes=normalizeAddedIndexes,exports.Operations=exports.RemoveColumnsCommand=exports.AddColumnsCommand=exports.AddRowsCommand=exports.RemoveRowsCommand=void 0;var _statistics=require("./statistics"),_ClipboardOperations=require("./ClipboardOperations"),_Cell=require("./Cell"),_CellContentParser=require("./CellContentParser"),_Span=require("./Span"),_ContentChanges=require("./ContentChanges"),_absolutizeDependencies=require("./absolutizeDependencies"),_GraphBuilder=require("./GraphBuilder"),_DependencyGraph=require("./DependencyGraph"),_errors2=require("./errors"),_parser=require("./parser"),_AddRowsTransformer=require("./dependencyTransformers/AddRowsTransformer"),_RemoveRowsTransformer=require("./dependencyTransformers/RemoveRowsTransformer"),_AddColumnsTransformer=require("./dependencyTransformers/AddColumnsTransformer"),_MoveCellsTransformer=require("./dependencyTransformers/MoveCellsTransformer"),_RemoveSheetTransformer=require("./dependencyTransformers/RemoveSheetTransformer"),_RemoveColumnsTransformer=require("./dependencyTransformers/RemoveColumnsTransformer"),_AbsoluteCellRange=require("./AbsoluteCellRange"),_Sheet=require("./Sheet"),_NamedExpressions=require("./NamedExpressions");function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_unsupportedIterableToArray(e,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,r){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var n=[],s=!0,t=!1,a=void 0;try{for(var o,i=e[Symbol.iterator]();!(s=(o=i.next()).done)&&(n.push(o.value),!r||n.length!==r);s=!0);}catch(e){t=!0,a=e}finally{try{s||null==i.return||i.return()}finally{if(t)throw a}}return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _createForOfIteratorHelper(e,r){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||r&&e&&"number"==typeof e.length){n&&(e=n);var s=0,t=function(){};return{s:t,n:function(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function(e){throw e},f:t}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,i=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return o=e.done,e},e:function(e){i=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(i)throw a}}}}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,r):void 0}}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var n=0,s=new Array(r);n<r;n++)s[n]=e[n];return s}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var n=0;n<r.length;n++){var s=r[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function _createClass(e,r,n){return r&&_defineProperties(e.prototype,r),n&&_defineProperties(e,n),e}var RemoveRowsCommand=function(){function e(r,n){_classCallCheck(this,e),this.sheet=r,this.indexes=n}return _createClass(e,[{key:"normalizedIndexes",value:function(){return normalizeRemovedIndexes(this.indexes)}},{key:"rowsSpans",value:function(){var e=this;return this.normalizedIndexes().map(function(r){return _Span.RowsSpan.fromNumberOfRows(e.sheet,r[0],r[1])})}}]),e}();exports.RemoveRowsCommand=RemoveRowsCommand;var AddRowsCommand=function(){function e(r,n){_classCallCheck(this,e),this.sheet=r,this.indexes=n}return _createClass(e,[{key:"normalizedIndexes",value:function(){return normalizeAddedIndexes(this.indexes)}},{key:"rowsSpans",value:function(){var e=this;return this.normalizedIndexes().map(function(r){return _Span.RowsSpan.fromNumberOfRows(e.sheet,r[0],r[1])})}}]),e}();exports.AddRowsCommand=AddRowsCommand;var AddColumnsCommand=function(){function e(r,n){_classCallCheck(this,e),this.sheet=r,this.indexes=n}return _createClass(e,[{key:"normalizedIndexes",value:function(){return normalizeAddedIndexes(this.indexes)}},{key:"columnsSpans",value:function(){var e=this;return this.normalizedIndexes().map(function(r){return _Span.ColumnsSpan.fromNumberOfColumns(e.sheet,r[0],r[1])})}}]),e}();exports.AddColumnsCommand=AddColumnsCommand;var RemoveColumnsCommand=function(){function e(r,n){_classCallCheck(this,e),this.sheet=r,this.indexes=n}return _createClass(e,[{key:"normalizedIndexes",value:function(){return normalizeRemovedIndexes(this.indexes)}},{key:"columnsSpans",value:function(){var e=this;return this.normalizedIndexes().map(function(r){return _Span.ColumnsSpan.fromNumberOfColumns(e.sheet,r[0],r[1])})}}]),e}();exports.RemoveColumnsCommand=RemoveColumnsCommand;var Operations=function(){function e(r,n,s,t,a,o,i,l){_classCallCheck(this,e),this.dependencyGraph=r,this.columnSearch=n,this.cellContentParser=s,this.parser=t,this.stats=a,this.lazilyTransformingAstService=o,this.namedExpressions=i,this.config=l,this.changes=_ContentChanges.ContentChanges.empty(),this.allocateNamedExpressionAddressSpace()}return _createClass(e,[{key:"removeRows",value:function(e){var r,n=[],s=_createForOfIteratorHelper(e.rowsSpans());try{for(s.s();!(r=s.n()).done;){var t=r.value,a=this.doRemoveRows(t);a&&n.push(a)}}catch(e){s.e(e)}finally{s.f()}return n}},{key:"addRows",value:function(e){var r,n=_createForOfIteratorHelper(e.rowsSpans());try{for(n.s();!(r=n.n()).done;){var s=r.value;this.doAddRows(s)}}catch(e){n.e(e)}finally{n.f()}}},{key:"addColumns",value:function(e){var r,n=_createForOfIteratorHelper(e.columnsSpans());try{for(n.s();!(r=n.n()).done;){var s=r.value;this.doAddColumns(s)}}catch(e){n.e(e)}finally{n.f()}}},{key:"removeColumns",value:function(e){var r,n=[],s=_createForOfIteratorHelper(e.columnsSpans());try{for(s.s();!(r=s.n()).done;){var t=r.value,a=this.doRemoveColumns(t);a&&n.push(a)}}catch(e){s.e(e)}finally{s.f()}return n}},{key:"removeSheet",value:function(e){var r,n=this,s=this.sheetMapping.fetch(e);return this.dependencyGraph.removeSheet(s),this.stats.measure(_statistics.StatType.TRANSFORM_ASTS,function(){var e=new _RemoveSheetTransformer.RemoveSheetTransformer(s);e.performEagerTransformations(n.dependencyGraph,n.parser),r=n.lazilyTransformingAstService.addTransformation(e)}),this.sheetMapping.removeSheet(s),this.columnSearch.removeSheet(s),r}},{key:"clearSheet",value:function(e){this.dependencyGraph.clearSheet(e),this.columnSearch.removeSheet(e)}},{key:"addSheet",value:function(e){var r=this.sheetMapping.addSheet(e),n=[];return this.dependencyGraph.addressMapping.autoAddSheet(r,n,(0,_Sheet.findBoundaries)(n)),this.sheetMapping.fetchDisplayName(r)}},{key:"renameSheet",value:function(e,r){return this.sheetMapping.renameSheet(e,r)}},{key:"moveRows",value:function(e,r,n,s){var t=_Span.RowsSpan.fromNumberOfRows(e,s,n);this.doAddRows(t),s<r&&(r+=n);var a=(0,_Cell.simpleCellAddress)(e,0,r),o=(0,_Cell.simpleCellAddress)(e,0,s);this.moveCells(a,Number.POSITIVE_INFINITY,n,o);var i=_Span.RowsSpan.fromNumberOfRows(e,r,n);this.doRemoveRows(i)}},{key:"moveColumns",value:function(e,r,n,s){var t=_Span.ColumnsSpan.fromNumberOfColumns(e,s,n);this.doAddColumns(t),s<r&&(r+=n);var a=(0,_Cell.simpleCellAddress)(e,r,0),o=(0,_Cell.simpleCellAddress)(e,s,0);this.moveCells(a,n,Number.POSITIVE_INFINITY,o);var i=_Span.ColumnsSpan.fromNumberOfColumns(e,r,n);this.doRemoveColumns(i)}},{key:"moveCells",value:function(e,r,n,s){var t=this;this.ensureItIsPossibleToMoveCells(e,r,n,s);var a=_AbsoluteCellRange.AbsoluteCellRange.spanFrom(e,r,n),o=_AbsoluteCellRange.AbsoluteCellRange.spanFrom(s,r,n);this.dependencyGraph.breakNumericMatricesInRange(a),this.dependencyGraph.breakNumericMatricesInRange(o);var i=s.col-e.col,l=s.row-e.row,d=s.sheet,p=this.getRangeClipboardCells(o),u=this.dependencyGraph.valuesFromRange(o);this.columnSearch.removeValues(u);var h,c=this.dependencyGraph.valuesFromRange(a);this.columnSearch.moveValues(c,i,l,d),this.stats.measure(_statistics.StatType.TRANSFORM_ASTS,function(){var e=new _MoveCellsTransformer.MoveCellsTransformer(a,i,l,d);e.performEagerTransformations(t.dependencyGraph,t.parser),h=t.lazilyTransformingAstService.addTransformation(e)}),this.dependencyGraph.moveCells(a,i,l,d);var m=this.updateNamedExpressionsForMovedCells(e,r,n,s);return{version:h,overwrittenCellsData:p,addedGlobalNamedExpressions:m}}},{key:"addNamedExpression",value:function(e,r,n,s){this.storeNamedExpressionInCell(this.namedExpressions.lookupNextAddress(e,n),r);var t=this.namedExpressions.addNamedExpression(e,n,s);this.adjustNamedExpressionEdges(t,e,n)}},{key:"restoreNamedExpression",value:function(e,r,n){var s=e.displayName,t=e.options;this.restoreCell(e.address,r);var a=this.namedExpressions.addNamedExpression(s,n,t);this.adjustNamedExpressionEdges(a,s,n)}},{key:"changeNamedExpressionExpression",value:function(e,r,n,s){var t=this.namedExpressions.namedExpressionForScope(e,n);if(!t)throw new _errors2.NamedExpressionDoesNotExistError(e);var a=t.copy();t.options=s;var o=this.getClipboardCell(t.address);return this.storeNamedExpressionInCell(t.address,r),[a,o]}},{key:"removeNamedExpression",value:function(e,r){var n=this.namedExpressions.namedExpressionForScope(e,r);if(!n)throw new _errors2.NamedExpressionDoesNotExistError(e);this.namedExpressions.remove(n.displayName,r);var s=this.getClipboardCell(n.address);if(void 0!==r){var t=this.namedExpressions.workbookNamedExpressionOrPlaceholder(e);this.dependencyGraph.exchangeNode(n.address,t.address)}else this.dependencyGraph.setCellEmpty(n.address);return[n,s]}},{key:"ensureItIsPossibleToMoveCells",value:function(e,r,n,s){if((0,_Cell.invalidSimpleCellAddress)(e)||!(isPositiveInteger(r)&&isPositiveInteger(n)||isRowOrColumnRange(e,r,n))||(0,_Cell.invalidSimpleCellAddress)(s)||!this.sheetMapping.hasSheetWithId(e.sheet)||!this.sheetMapping.hasSheetWithId(s.sheet))throw new _errors2.InvalidArgumentsError("a valid range of cells to move.");var t=_AbsoluteCellRange.AbsoluteCellRange.spanFrom(e,r,n),a=_AbsoluteCellRange.AbsoluteCellRange.spanFrom(s,r,n);if(a.exceedsSheetSizeLimits(this.config.maxColumns,this.config.maxRows))throw new _errors2.SheetSizeLimitExceededError;if(this.dependencyGraph.matrixMapping.isFormulaMatrixInRange(t))throw new _errors2.SourceLocationHasMatrixError;if(this.dependencyGraph.matrixMapping.isFormulaMatrixInRange(a))throw new _errors2.TargetLocationHasMatrixError}},{key:"restoreClipboardCells",value:function(e,r){var n,s=[],t=_createForOfIteratorHelper(r);try{for(t.s();!(n=t.n()).done;){var a=_slicedToArray(n.value,2),o=a[0],i=a[1];if(this.restoreCell(o,i),i.type===_ClipboardOperations.ClipboardCellType.FORMULA){var l=this.parser.fetchCachedResult(i.hash).dependencies;s.push.apply(s,_toConsumableArray(this.updateNamedExpressionsForTargetAddress(e,o,l)))}}}catch(e){t.e(e)}finally{t.f()}return s}},{key:"restoreCell",value:function(e,r){switch(r.type){case _ClipboardOperations.ClipboardCellType.VALUE:this.setValueToCell(r.value,e);break;case _ClipboardOperations.ClipboardCellType.FORMULA:this.setFormulaToCellFromCache(r.hash,e);break;case _ClipboardOperations.ClipboardCellType.EMPTY:this.setCellEmpty(e);break;case _ClipboardOperations.ClipboardCellType.PARSING_ERROR:this.setParsingErrorToCell(r.rawInput,r.errors,e)}}},{key:"doRemoveRows",value:function(e){var r=this;if(!this.rowEffectivelyNotInSheet(e.rowStart,e.sheet)){var n,s,t=[],a=_createForOfIteratorHelper(this.dependencyGraph.entriesFromRowsSpan(e));try{for(a.s();!(n=a.n()).done;){var o=_slicedToArray(n.value,1)[0];t.push({address:o,cellType:this.getClipboardCell(o)})}}catch(e){a.e(e)}finally{a.f()}return this.dependencyGraph.removeRows(e),this.stats.measure(_statistics.StatType.TRANSFORM_ASTS,function(){var n=new _RemoveRowsTransformer.RemoveRowsTransformer(e);n.performEagerTransformations(r.dependencyGraph,r.parser),s=r.lazilyTransformingAstService.addTransformation(n)}),{version:s,removedCells:t,rowFrom:e.rowStart,rowCount:e.numberOfRows}}}},{key:"doRemoveColumns",value:function(e){var r=this;if(!this.columnEffectivelyNotInSheet(e.columnStart,e.sheet)){var n,s,t=[],a=_createForOfIteratorHelper(this.dependencyGraph.entriesFromColumnsSpan(e));try{for(a.s();!(n=a.n()).done;){var o=_slicedToArray(n.value,1)[0];t.push({address:o,cellType:this.getClipboardCell(o)})}}catch(e){a.e(e)}finally{a.f()}return this.dependencyGraph.removeColumns(e),this.columnSearch.removeColumns(e),this.stats.measure(_statistics.StatType.TRANSFORM_ASTS,function(){var n=new _RemoveColumnsTransformer.RemoveColumnsTransformer(e);n.performEagerTransformations(r.dependencyGraph,r.parser),s=r.lazilyTransformingAstService.addTransformation(n)}),{version:s,removedCells:t,columnFrom:e.columnStart,columnCount:e.numberOfColumns}}}},{key:"doAddRows",value:function(e){var r=this;this.rowEffectivelyNotInSheet(e.rowStart,e.sheet)||(this.dependencyGraph.addRows(e),this.stats.measure(_statistics.StatType.TRANSFORM_ASTS,function(){var n=new _AddRowsTransformer.AddRowsTransformer(e);n.performEagerTransformations(r.dependencyGraph,r.parser),r.lazilyTransformingAstService.addTransformation(n)}))}},{key:"doAddColumns",value:function(e){var r=this;this.columnEffectivelyNotInSheet(e.columnStart,e.sheet)||(this.dependencyGraph.addColumns(e),this.columnSearch.addColumns(e),this.stats.measure(_statistics.StatType.TRANSFORM_ASTS,function(){var n=new _AddColumnsTransformer.AddColumnsTransformer(e);n.performEagerTransformations(r.dependencyGraph,r.parser),r.lazilyTransformingAstService.addTransformation(n)}))}},{key:"getClipboardCell",value:function(e){var r=this.dependencyGraph.getCell(e);if(null===r||r instanceof _DependencyGraph.EmptyCellVertex)return{type:_ClipboardOperations.ClipboardCellType.EMPTY};if(r instanceof _DependencyGraph.ValueCellVertex)return{type:_ClipboardOperations.ClipboardCellType.VALUE,value:r.getCellValue()};if(r instanceof _DependencyGraph.MatrixVertex)return{type:_ClipboardOperations.ClipboardCellType.VALUE,value:r.getMatrixCellValue(e)};if(r instanceof _DependencyGraph.FormulaCellVertex)return{type:_ClipboardOperations.ClipboardCellType.FORMULA,hash:this.parser.computeHashFromAst(r.getFormula(this.lazilyTransformingAstService))};if(r instanceof _DependencyGraph.ParsingErrorVertex)return{type:_ClipboardOperations.ClipboardCellType.PARSING_ERROR,rawInput:r.rawInput,errors:r.errors};throw Error("Trying to copy unsupported type")}},{key:"getSheetClipboardCells",value:function(e){for(var r=this.dependencyGraph.getSheetHeight(e),n=this.dependencyGraph.getSheetWidth(e),s=new Array(r),t=0;t<r;t++){s[t]=new Array(n);for(var a=0;a<n;a++){var o=(0,_Cell.simpleCellAddress)(e,a,t);s[t][a]=this.getClipboardCell(o)}}return s}},{key:"getRangeClipboardCells",value:function(e){var r,n=[],s=_createForOfIteratorHelper(e.addresses(this.dependencyGraph));try{for(s.s();!(r=s.n()).done;){var t=r.value;n.push([t,this.getClipboardCell(t)])}}catch(e){s.e(e)}finally{s.f()}return n}},{key:"setCellContent",value:function(e,r){var n=this.cellContentParser.parse(r),s=this.dependencyGraph.getCell(e);if(!(s instanceof _DependencyGraph.MatrixVertex)||s.isFormula()||n instanceof _CellContentParser.CellContent.Number||(this.dependencyGraph.breakNumericMatrix(s),s=this.dependencyGraph.getCell(e)),s instanceof _DependencyGraph.MatrixVertex&&!s.isFormula()&&n instanceof _CellContentParser.CellContent.Number){var t=n.value,a=this.dependencyGraph.getCellValue(e);this.dependencyGraph.graph.markNodeAsSpecialRecentlyChanged(s),s.setMatrixCellValue(e,t),this.columnSearch.change(a,t,e),this.changes.addChange(t,e)}else if(!(s instanceof _DependencyGraph.MatrixVertex)&&n instanceof _CellContentParser.CellContent.MatrixFormula){var o=this.parser.parse(n.formula,e),i=o.ast,l=o.errors,d=o.dependencies;if(l.length>0)this.dependencyGraph.setParsingErrorToCell(e,new _DependencyGraph.ParsingErrorVertex(l,n.formulaWithBraces()));else{var p=(0,_GraphBuilder.buildMatrixVertex)(i,e);if(p instanceof _DependencyGraph.ValueCellVertex)throw Error("What if new matrix vertex is not properly constructed?");this.dependencyGraph.addNewMatrixVertex(p),this.dependencyGraph.processCellDependencies((0,_absolutizeDependencies.absolutizeDependencies)(d,e),p),this.dependencyGraph.graph.markNodeAsSpecialRecentlyChanged(p)}}else{if(s instanceof _DependencyGraph.MatrixVertex)throw new Error("Illegal operation");if(n instanceof _CellContentParser.CellContent.Formula){var u=this.parser.parse(n.formula,e),h=u.ast,c=u.errors,m=u.hasVolatileFunction,f=u.hasStructuralChangeFunction,y=u.dependencies;c.length>0?this.dependencyGraph.setParsingErrorToCell(e,new _DependencyGraph.ParsingErrorVertex(c,n.formula)):this.dependencyGraph.setFormulaToCell(e,h,(0,_absolutizeDependencies.absolutizeDependencies)(y,e),m,f)}else if(n instanceof _CellContentParser.CellContent.Empty)this.setCellEmpty(e);else{if(n instanceof _CellContentParser.CellContent.MatrixFormula)throw new Error("Cant happen");this.setValueToCell(n.value,e)}}}},{key:"setSheetContent",value:function(e,r){this.clearSheet(e);for(var n=0;n<r.length;n++)for(var s=0;s<r[n].length;s++){var t=(0,_Cell.simpleCellAddress)(e,s,n);this.setCellContent(t,r[n][s])}}},{key:"setValueToCell",value:function(e,r){var n=this.dependencyGraph.getCellValue(r);this.dependencyGraph.setValueToCell(r,e),this.columnSearch.change(n,e,r),this.changes.addChange(e,r)}},{key:"setCellEmpty",value:function(e){var r=this.dependencyGraph.getCellValue(e);this.columnSearch.remove(r,e),this.changes.addChange(_Cell.EmptyValue,e),this.dependencyGraph.setCellEmpty(e)}},{key:"setFormulaToCellFromCache",value:function(e,r){var n=this.parser.fetchCachedResult(e),s=n.ast,t=n.hasVolatileFunction,a=n.hasStructuralChangeFunction,o=n.dependencies;this.dependencyGraph.setFormulaToCell(r,s,(0,_absolutizeDependencies.absolutizeDependencies)(o,r),t,a)}},{key:"setParsingErrorToCell",value:function(e,r,n){this.dependencyGraph.setParsingErrorToCell(n,new _DependencyGraph.ParsingErrorVertex(r,e))}},{key:"rowEffectivelyNotInSheet",value:function(e,r){return e>=this.dependencyGraph.addressMapping.getHeight(r)}},{key:"getAndClearContentChanges",value:function(){var e=this.changes;return this.changes=_ContentChanges.ContentChanges.empty(),e}},{key:"forceApplyPostponedTransformations",value:function(){this.dependencyGraph.forceApplyPostponedTransformations()}},{key:"columnEffectivelyNotInSheet",value:function(e,r){return e>=this.dependencyGraph.addressMapping.getWidth(r)}},{key:"adjustNamedExpressionEdges",value:function(e,r,n){if(void 0!==n){var s,t=this.dependencyGraph.fetchCellOrCreateEmpty(e.address),a=this.namedExpressions.workbookNamedExpressionOrPlaceholder(r),o=this.dependencyGraph.fetchCellOrCreateEmpty(a.address),i=_createForOfIteratorHelper(this.dependencyGraph.graph.adjacentNodes(o));try{for(i.s();!(s=i.n()).done;){var l=s.value;if((l instanceof _DependencyGraph.FormulaCellVertex||l instanceof _DependencyGraph.MatrixVertex)&&l.cellAddress.sheet===n){var d=l.getFormula(this.lazilyTransformingAstService);if(d){var p,u=l.getAddress(this.lazilyTransformingAstService),h=this.parser.fetchCachedResultForAst(d).dependencies,c=_createForOfIteratorHelper((0,_absolutizeDependencies.absolutizeDependencies)(h,u));try{for(c.s();!(p=c.n()).done;){var m=p.value;m instanceof _parser.NamedExpressionDependency&&m.name.toLowerCase()===e.displayName.toLowerCase()&&(this.dependencyGraph.graph.removeEdge(o,l),this.dependencyGraph.graph.addEdge(t,l))}}catch(e){c.e(e)}finally{c.f()}}}}}catch(e){i.e(e)}finally{i.f()}}}},{key:"storeNamedExpressionInCell",value:function(e,r){var n=this.cellContentParser.parse(r);if(n instanceof _CellContentParser.CellContent.MatrixFormula)throw new Error("Matrix formulas are not supported");if(n instanceof _CellContentParser.CellContent.Formula){var s=this.parser.parse(n.formula,(0,_Cell.simpleCellAddress)(-1,0,0));if((0,_NamedExpressions.doesContainRelativeReferences)(s.ast))throw new _errors2.NoRelativeAddressesAllowedError;var t=s.ast,a=s.hasVolatileFunction,o=s.hasStructuralChangeFunction,i=s.dependencies;this.dependencyGraph.setFormulaToCell(e,t,(0,_absolutizeDependencies.absolutizeDependencies)(i,e),a,o)}else n instanceof _CellContentParser.CellContent.Empty?this.setCellEmpty(e):this.setValueToCell(n.value,e)}},{key:"updateNamedExpressionsForMovedCells",value:function(e,r,n,s){if(e.sheet===s.sheet)return[];var t,a=[],o=_createForOfIteratorHelper(_AbsoluteCellRange.AbsoluteCellRange.spanFrom(s,r,n).addresses(this.dependencyGraph));try{for(o.s();!(t=o.n()).done;){var i=t.value,l=this.addressMapping.fetchCell(i);if(l instanceof _DependencyGraph.FormulaCellVertex&&i.sheet!==e.sheet){var d=l.getFormula(this.lazilyTransformingAstService),p=this.parser.fetchCachedResultForAst(d).dependencies;a.push.apply(a,_toConsumableArray(this.updateNamedExpressionsForTargetAddress(e.sheet,i,p)))}}}catch(e){o.e(e)}finally{o.f()}return a}},{key:"updateNamedExpressionsForTargetAddress",value:function(e,r,n){if(e===r.sheet)return[];var s,t=[],a=this.addressMapping.fetchCell(r),o=_createForOfIteratorHelper((0,_absolutizeDependencies.absolutizeDependencies)(n,r));try{for(o.s();!(s=o.n()).done;){var i=s.value;if(i instanceof _parser.NamedExpressionDependency){var l=i.name,d=this.dependencyGraph.fetchNamedExpressionVertex(l,e),p=this.namedExpressions.isExpressionInScope(l,r.sheet)?this.dependencyGraph.fetchNamedExpressionVertex(l,r.sheet):this.copyOrFetchGlobalNamedExpressionVertex(l,d,t);p!==d&&(this.dependencyGraph.graph.softRemoveEdge(d,a),this.dependencyGraph.graph.addEdge(p,a))}}}catch(e){o.e(e)}finally{o.f()}return t}},{key:"allocateNamedExpressionAddressSpace",value:function(){this.dependencyGraph.addressMapping.addSheet(-1,new _DependencyGraph.SparseStrategy(0,0))}},{key:"copyOrFetchGlobalNamedExpressionVertex",value:function(e,r,n){var s=this.namedExpressions.namedExpressionForScope(e);if(void 0===s)if(s=this.namedExpressions.addNamedExpression(e),n.push(s.normalizeExpressionName()),r instanceof _DependencyGraph.FormulaCellVertex){var t=this.parser.fetchCachedResultForAst(r.getFormula(this.lazilyTransformingAstService)),a=t.ast,o=t.hasVolatileFunction,i=t.hasStructuralChangeFunction,l=t.dependencies;this.dependencyGraph.setFormulaToCell(s.address,a,(0,_absolutizeDependencies.absolutizeDependencies)(l,s.address),o,i)}else r instanceof _DependencyGraph.EmptyCellVertex?this.setCellEmpty(s.address):r instanceof _DependencyGraph.ValueCellVertex&&this.setValueToCell(r.getCellValue(),s.address);return this.dependencyGraph.fetchCellOrCreateEmpty(s.address)}},{key:"sheetMapping",get:function(){return this.dependencyGraph.sheetMapping}},{key:"addressMapping",get:function(){return this.dependencyGraph.addressMapping}}]),e}();function normalizeRemovedIndexes(e){if(e.length<=1)return e;for(var r=e.sort(function(e,r){var n=_slicedToArray(e,1)[0],s=_slicedToArray(r,1)[0];return n<s?-1:n>s?1:0}),n=r.reduce(function(e,r){var n=_slicedToArray(r,2),s=n[0],t=n[1],a=e[e.length-1],o=a[0]+a[1];return s<=o?a[1]+=Math.max(0,t-(o-s)):e.push([s,t]),e},[r[0]]),s=0,t=0;t<n.length;++t)n[t][0]-=s,s+=n[t][1];return n}function normalizeAddedIndexes(e){if(e.length<=1)return e;for(var r=e.sort(function(e,r){var n=_slicedToArray(e,1)[0],s=_slicedToArray(r,1)[0];return n<s?-1:n>s?1:0}),n=r.reduce(function(e,r){var n=_slicedToArray(r,2),s=n[0],t=n[1],a=e[e.length-1];return s===a[0]?a[1]=Math.max(a[1],t):e.push([s,t]),e},[r[0]]),s=0,t=0;t<n.length;++t)n[t][0]+=s,s+=n[t][1];return n}function isPositiveInteger(e){return Number.isInteger(e)&&e>0}function isRowOrColumnRange(e,r,n){return 0===e.row&&isPositiveInteger(r)&&n===Number.POSITIVE_INFINITY||0===e.col&&isPositiveInteger(n)&&r===Number.POSITIVE_INFINITY}exports.Operations=Operations;
//# sourceMappingURL=/sm/c8cdadd30ddebc647d76485926723b55d93cbf2b2630f5570f79c643992990aa.map